-- ============================================
-- RADIOHUB v4 — SUPABASE SCHEMA
-- ============================================
-- Execute este script no SQL Editor do Supabase
-- (Dashboard > SQL Editor > New Query > Cole e Execute)

-- 1. TABELA: resumos
CREATE TABLE resumos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  spec TEXT NOT NULL,           -- 'neuro', 'torax', 'gi', etc
  sub2 TEXT,                     -- 'Encéfalo', 'Parênquima Pulmonar', etc
  name TEXT NOT NULL,            -- Título do resumo
  tags TEXT[],                   -- Array de tags: ['TC', 'RM']
  body_html TEXT NOT NULL,       -- HTML rico do conteúdo
  img_url TEXT,                  -- URL da imagem principal (opcional)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. TABELA: artigos
CREATE TABLE artigos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  spec TEXT NOT NULL,
  sub2 TEXT,
  name TEXT NOT NULL,            -- Título do artigo
  journal TEXT,                  -- Ex: "Radiology · 2024"
  author TEXT,                   -- Ex: "Silva et al."
  tags TEXT[],
  body_html TEXT NOT NULL,
  img_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. TABELA: templates
CREATE TABLE templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  spec TEXT NOT NULL,
  sub2 TEXT,
  name TEXT NOT NULL,
  tags TEXT[],
  template_text TEXT NOT NULL,   -- Texto do template (plaintext)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. TABELA: frases
CREATE TABLE frases (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  spec TEXT NOT NULL,
  sub2 TEXT,
  name TEXT NOT NULL,
  tags TEXT[],
  text TEXT NOT NULL,            -- Texto da frase
  resumo_id UUID REFERENCES resumos(id) ON DELETE SET NULL,  -- Link opcional
  artigo_id UUID REFERENCES artigos(id) ON DELETE SET NULL,  -- Link opcional
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. TABELA: checklists
CREATE TABLE checklists (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  spec TEXT NOT NULL,
  sub2 TEXT,
  name TEXT NOT NULL,
  tags TEXT[],
  sections_json JSONB NOT NULL, -- JSON com estrutura: {"Seção 1": ["item1", "item2"], ...}
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6. TABELA: calculadoras
CREATE TABLE calculadoras (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  spec TEXT NOT NULL,
  sub2 TEXT,
  name TEXT NOT NULL,
  tags TEXT[],
  code_html TEXT NOT NULL,       -- HTML/JS da calculadora
  description TEXT,               -- Descrição curta
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- ÍNDICES (para buscas rápidas)
-- ============================================

CREATE INDEX idx_resumos_spec ON resumos(spec);
CREATE INDEX idx_resumos_sub2 ON resumos(sub2);
CREATE INDEX idx_artigos_spec ON artigos(spec);
CREATE INDEX idx_artigos_sub2 ON artigos(sub2);
CREATE INDEX idx_templates_spec ON templates(spec);
CREATE INDEX idx_frases_spec ON frases(spec);
CREATE INDEX idx_checklists_spec ON checklists(spec);
CREATE INDEX idx_calculadoras_spec ON calculadoras(spec);

-- ============================================
-- ROW LEVEL SECURITY (RLS)
-- ============================================
-- Permite leitura pública, mas escrita só com autenticação

ALTER TABLE resumos ENABLE ROW LEVEL SECURITY;
ALTER TABLE artigos ENABLE ROW LEVEL SECURITY;
ALTER TABLE templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE frases ENABLE ROW LEVEL SECURITY;
ALTER TABLE checklists ENABLE ROW LEVEL SECURITY;
ALTER TABLE calculadoras ENABLE ROW LEVEL SECURITY;

-- Política: qualquer um pode LER
CREATE POLICY "Leitura pública - resumos" ON resumos FOR SELECT USING (true);
CREATE POLICY "Leitura pública - artigos" ON artigos FOR SELECT USING (true);
CREATE POLICY "Leitura pública - templates" ON templates FOR SELECT USING (true);
CREATE POLICY "Leitura pública - frases" ON frases FOR SELECT USING (true);
CREATE POLICY "Leitura pública - checklists" ON checklists FOR SELECT USING (true);
CREATE POLICY "Leitura pública - calculadoras" ON calculadoras FOR SELECT USING (true);

-- Política: só autenticados podem INSERIR/ATUALIZAR/DELETAR
CREATE POLICY "Admin pode escrever - resumos" ON resumos FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Admin pode escrever - artigos" ON artigos FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Admin pode escrever - templates" ON templates FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Admin pode escrever - frases" ON frases FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Admin pode escrever - checklists" ON checklists FOR ALL USING (auth.role() = 'authenticated');
CREATE POLICY "Admin pode escrever - calculadoras" ON calculadoras FOR ALL USING (auth.role() = 'authenticated');

-- ============================================
-- FUNÇÃO: atualizar updated_at automaticamente
-- ============================================

CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers para updated_at
CREATE TRIGGER resumos_updated_at BEFORE UPDATE ON resumos FOR EACH ROW EXECUTE FUNCTION update_updated_at();
CREATE TRIGGER artigos_updated_at BEFORE UPDATE ON artigos FOR EACH ROW EXECUTE FUNCTION update_updated_at();
CREATE TRIGGER templates_updated_at BEFORE UPDATE ON templates FOR EACH ROW EXECUTE FUNCTION update_updated_at();
CREATE TRIGGER frases_updated_at BEFORE UPDATE ON frases FOR EACH ROW EXECUTE FUNCTION update_updated_at();
CREATE TRIGGER checklists_updated_at BEFORE UPDATE ON checklists FOR EACH ROW EXECUTE FUNCTION update_updated_at();
CREATE TRIGGER calculadoras_updated_at BEFORE UPDATE ON calculadoras FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- ============================================
-- DADOS DE EXEMPLO (opcional - remova depois)
-- ============================================

-- Template de exemplo
INSERT INTO templates (spec, sub2, name, tags, template_text) VALUES
('torax', 'Parênquima Pulmonar', 'TC Tórax - Protocolo Básico', ARRAY['TC'], 
'TC TÓRAX

Técnica
[Descrever técnica, fases]

Análise
Parênquima pulmonar: ________________________.
Pleuras: ________________________.
Mediastino: ________________________.

Conclusão
________________________.');

-- Frase de exemplo
INSERT INTO frases (spec, sub2, name, tags, text) VALUES
('torax', 'Parênquima Pulmonar', 'Pulmões sem alterações', ARRAY['TC', 'RX'],
'Parênquima pulmonar com transparência preservada, sem nódulos, consolidações ou opacidades em vidro fosco. Traqueia e brônquios principais pérvios.');

-- Checklist de exemplo
INSERT INTO checklists (spec, sub2, name, tags, sections_json) VALUES
('torax', 'Parênquima Pulmonar', 'TC Tórax - Checklist', ARRAY['TC'],
'{"Parênquima": ["Campos transparentes", "Sem nódulos/massas", "Sem consolidações", "Sem vidro fosco"], "Pleuras": ["Pleuras livres", "Sem derrame", "Sem pneumotórax"], "Mediastino": ["Sem adenopatias", "Aorta sem aneurisma", "Pericárdio normal"]}'::jsonb);

-- ============================================
-- CONCLUÍDO!
-- ============================================
-- Após executar, vá em: Authentication > Policies
-- E confirme que as políticas estão ativas.
