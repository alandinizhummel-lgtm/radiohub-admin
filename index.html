<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RadioHub Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:system-ui,sans-serif;background:#0b0c10;color:#e2e5f0;min-height:100vh;}
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;}
.login-box{background:#14161f;border:1px solid #222533;border-radius:12px;padding:2.5rem;width:100%;max-width:420px;}
.login-title{font-size:1.8rem;margin-bottom:0.5rem;color:#fff;}
.login-sub{font-size:0.9rem;color:#8d94b0;margin-bottom:2rem;}
.form-group{margin-bottom:1.2rem;}
.form-label{display:block;font-size:0.85rem;color:#c0c5d8;margin-bottom:0.4rem;}
.form-input{width:100%;background:#1a1d28;border:1px solid #2d3044;border-radius:8px;padding:0.7rem 1rem;color:#fff;font-size:0.95rem;}
.form-input:focus{outline:none;border-color:#4f8ef7;}
.btn{padding:0.75rem 1.5rem;border-radius:8px;border:none;font-size:0.95rem;cursor:pointer;font-weight:600;transition:all 0.2s;}
.btn-primary{background:#4f8ef7;color:#fff;width:100%;}
.btn-primary:hover{background:#3d7ce3;}
.admin-screen{display:none;padding:2rem;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:2px solid #222533;}
.header-title{font-size:1.8rem;font-weight:700;}
.btn-logout{background:#e05c5c;color:#fff;padding:0.5rem 1rem;font-size:0.85rem;}
.tabs{display:flex;gap:0.5rem;margin-bottom:2rem;border-bottom:1px solid #222533;}
.tab{padding:0.75rem 1.5rem;background:none;border:none;color:#8d94b0;font-size:0.9rem;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
.tab.active{color:#4f8ef7;border-bottom-color:#4f8ef7;}
.tab:hover{color:#c0c5d8;}
.content{background:#14161f;border:1px solid #222533;border-radius:12px;padding:2rem;}
.btn-new{background:#3fc983;color:#fff;margin-bottom:1.5rem;}
.btn-new:hover{background:#32a56b;}
.item-list{display:flex;flex-direction:column;gap:0.75rem;}
.item{background:#1a1d28;border:1px solid #2d3044;border-radius:8px;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
.item-info h3{font-size:1rem;color:#fff;margin-bottom:0.25rem;}
.item-info p{font-size:0.85rem;color:#8d94b0;}
.item-actions{display:flex;gap:0.5rem;}
.btn-sm{padding:0.4rem 0.8rem;font-size:0.8rem;}
.btn-edit{background:#f0944d;color:#fff;}
.btn-delete{background:#e05c5c;color:#fff;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:1000;padding:2rem;}
.modal.show{display:flex;}
.modal-content{background:#14161f;border:1px solid #222533;border-radius:12px;padding:2rem;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
.modal-title{font-size:1.4rem;color:#fff;}
.btn-close{background:none;border:none;color:#8d94b0;font-size:1.5rem;cursor:pointer;}
textarea{width:100%;min-height:200px;background:#1a1d28;border:1px solid #2d3044;border-radius:8px;padding:1rem;color:#fff;font-family:monospace;font-size:0.9rem;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
select{width:100%;background:#1a1d28;border:1px solid #2d3044;border-radius:8px;padding:0.7rem 1rem;color:#fff;}
.empty{text-align:center;padding:3rem;color:#6b7388;}
.alert{padding:1rem;border-radius:8px;margin-bottom:1rem;}
.alert-error{background:rgba(224,92,92,0.1);border:1px solid #e05c5c;color:#ff9999;}
.alert-success{background:rgba(63,201,131,0.1);border:1px solid #3fc983;color:#7dffb8;}
</style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <h1 class="login-title">RadioHub Admin</h1>
    <p class="login-sub">Entre com suas credenciais do Supabase</p>
    <div id="login-alert"></div>
    <form onsubmit="login(event)">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="email" required placeholder="seu@email.com">
      </div>
      <div class="form-group">
        <label class="form-label">Senha</label>
        <input type="password" class="form-input" id="password" required>
      </div>
      <button type="submit" class="btn btn-primary">Entrar</button>
    </form>
  </div>
</div>

<!-- TELA ADMIN -->
<div class="admin-screen" id="admin-screen">
  <div class="header">
    <h1 class="header-title">RadioHub Admin</h1>
    <button class="btn btn-logout" onclick="logout()">Sair</button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('templates')">Templates</button>
    <button class="tab" onclick="switchTab('frases')">Frases</button>
    <button class="tab" onclick="switchTab('checklists')">Checklists</button>
  </div>

  <div class="content" id="content"></div>
</div>

<!-- MODAL TEMPLATE -->
<div class="modal" id="modal-templates">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-templates-title">Novo Template</h2>
      <button class="btn-close" onclick="closeModal('templates')">√ó</button>
    </div>
    <form onsubmit="saveTemplate(event)">
      <input type="hidden" id="template-id">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Especialidade</label>
          <select class="form-input" id="template-spec" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Sub√°rea</label>
          <input type="text" class="form-input" id="template-sub2" placeholder="Ex: Par√™nquima Pulmonar">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Nome</label>
        <input type="text" class="form-input" id="template-name" required placeholder="Ex: TC T√≥rax ‚Äî Protocolo">
      </div>
      <div class="form-group">
        <label class="form-label">Texto do Template</label>
        <textarea id="template-text" required placeholder="TC T√ìRAX&#10;&#10;T√©cnica&#10;[Descrever t√©cnica]&#10;&#10;..."></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Salvar Template</button>
    </form>
  </div>
</div>

<!-- MODAL FRASE -->
<div class="modal" id="modal-frases">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-frases-title">Nova Frase</h2>
      <button class="btn-close" onclick="closeModal('frases')">√ó</button>
    </div>
    <form onsubmit="saveFrase(event)">
      <input type="hidden" id="frase-id">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Especialidade</label>
          <select class="form-input" id="frase-spec" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Sub√°rea</label>
          <input type="text" class="form-input" id="frase-sub2" placeholder="Ex: Embolia/TEP">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Nome</label>
        <input type="text" class="form-input" id="frase-name" required placeholder="Ex: TEP negativo">
      </div>
      <div class="form-group">
        <label class="form-label">Texto da Frase</label>
        <textarea id="frase-text" required placeholder="Estudo angio-TC de t√≥rax sem evid√™ncias de..."></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Salvar Frase</button>
    </form>
  </div>
</div>

<!-- MODAL CHECKLIST -->
<div class="modal" id="modal-checklists">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-checklists-title">Novo Checklist</h2>
      <button class="btn-close" onclick="closeModal('checklists')">√ó</button>
    </div>
    <form onsubmit="saveChecklist(event)">
      <input type="hidden" id="checklist-id">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Especialidade</label>
          <select class="form-input" id="checklist-spec" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Sub√°rea</label>
          <input type="text" class="form-input" id="checklist-sub2" placeholder="Ex: Par√™nquima Pulmonar">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Nome</label>
        <input type="text" class="form-input" id="checklist-name" required placeholder="Ex: TC T√≥rax ‚Äî Checklist">
      </div>
      <div class="form-group">
        <label class="form-label">Se√ß√µes (JSON)</label>
        <textarea id="checklist-sections" required placeholder='{"Par√™nquima": ["Item 1", "Item 2"], "Pleuras": ["Item 3"]}'></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Salvar Checklist</button>
    </form>
  </div>
</div>

<script>
// CONFIGURA√á√ÉO SUPABASE
const SUPABASE_CONFIG = {
  url: 'https://qlfqtxcbeuvlznqzzhke.supabase.co',
  anonKey: 'sb_publishable_G2Z4YKFIg6vgRh7BcDPFLw_eoPW9uaV'
};
const supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

const SPECS={neuro:'Neurorradiologia',torax:'T√≥rax',cn:'Cabe√ßa e Pesco√ßo',gi:'Digestivo',gu:'Geniturin√°rio',msk:'MSK',mama:'Mama',vasc:'Vascular',us:'Ultrassom',contraste:'Contraste'};
let currentTab='templates';
let currentUser=null;

async function login(e){
  e.preventDefault();
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const alert=document.getElementById('login-alert');
  alert.innerHTML='<div class="alert alert-success">Conectando...</div>';
  
  const{data,error}=await supabaseClient.auth.signInWithPassword({email,password});
  if(error){
    alert.innerHTML='<div class="alert alert-error">‚ùå '+error.message+'</div>';
    return;
  }
  currentUser=data.user;
  document.getElementById('login-screen').style.display='none';
  document.getElementById('admin-screen').style.display='block';
  loadData(currentTab);
}

async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  loadData(tab);
}

async function loadData(tab){
  const content=document.getElementById('content');
  content.innerHTML='<p style="text-align:center;padding:2rem;color:#8d94b0">‚è≥ Carregando...</p>';
  const{data,error}=await supabaseClient.from(tab).select('*').order('created_at',{ascending:false});
  if(error){
    content.innerHTML='<div class="alert alert-error">‚ùå Erro: '+error.message+'</div>';
    return;
  }
  renderList(tab,data);
}

function renderList(tab,data){
  const content=document.getElementById('content');
  const labels={templates:'Template',frases:'Frase',checklists:'Checklist'};
  let html=`<button class="btn btn-new" onclick="openModal('${tab}')">+ Novo ${labels[tab]}</button>`;
  if(!data.length){
    html+='<p class="empty">üì≠ Nenhum item criado ainda.<br><br>Clique em "Novo" para come√ßar!</p>';
  }else{
    html+='<div class="item-list">';
    data.forEach(item=>{
      html+=`<div class="item">
        <div class="item-info">
          <h3>${item.name}</h3>
          <p>${SPECS[item.spec]||item.spec} ${item.sub2?'¬∑ '+item.sub2:''}</p>
        </div>
        <div class="item-actions">
          <button class="btn btn-sm btn-edit" onclick='editItem("${tab}","${item.id}")'>‚úèÔ∏è Editar</button>
          <button class="btn btn-sm btn-delete" onclick='deleteItem("${tab}","${item.id}")'>üóëÔ∏è Deletar</button>
        </div>
      </div>`;
    });
    html+='</div>';
  }
  content.innerHTML=html;
}

function openModal(tab,id=null){
  populateSpecSelects();
  document.getElementById(`modal-${tab}`).classList.add('show');
  if(id)loadItemForEdit(tab,id);
  else resetForm(tab);
}

function closeModal(tab){
  document.getElementById(`modal-${tab}`).classList.remove('show');
}

function populateSpecSelects(){
  ['template','frase','checklist'].forEach(type=>{
    const sel=document.getElementById(`${type}-spec`);
    sel.innerHTML=Object.entries(SPECS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');
  });
}

function resetForm(tab){
  const singular=tab.replace(/s$/,'');
  document.getElementById(`${singular}-id`).value='';
  document.getElementById(`${singular}-spec`).value='neuro';
  document.getElementById(`${singular}-sub2`).value='';
  document.getElementById(`${singular}-name`).value='';
  if(tab==='templates')document.getElementById('template-text').value='';
  if(tab==='frases')document.getElementById('frase-text').value='';
  if(tab==='checklists')document.getElementById('checklist-sections').value='';
}

async function loadItemForEdit(tab,id){
  const singular=tab.replace(/s$/,'');
  const{data,error}=await supabaseClient.from(tab).select('*').eq('id',id).single();
  if(error){alert('‚ùå '+error.message);return;}
  document.getElementById(`${singular}-id`).value=data.id;
  document.getElementById(`${singular}-spec`).value=data.spec;
  document.getElementById(`${singular}-sub2`).value=data.sub2||'';
  document.getElementById(`${singular}-name`).value=data.name;
  if(tab==='templates')document.getElementById('template-text').value=data.template_text;
  if(tab==='frases')document.getElementById('frase-text').value=data.text;
  if(tab==='checklists')document.getElementById('checklist-sections').value=JSON.stringify(data.sections_json,null,2);
}

async function saveTemplate(e){
  e.preventDefault();
  const id=document.getElementById('template-id').value;
  const payload={
    spec:document.getElementById('template-spec').value,
    sub2:document.getElementById('template-sub2').value||null,
    name:document.getElementById('template-name').value,
    tags:[],
    template_text:document.getElementById('template-text').value
  };
  const{error}=id
    ?await supabaseClient.from('templates').update(payload).eq('id',id)
    :await supabaseClient.from('templates').insert(payload);
  if(error){alert('‚ùå '+error.message);return;}
  closeModal('templates');
  loadData('templates');
}

async function saveFrase(e){
  e.preventDefault();
  const id=document.getElementById('frase-id').value;
  const payload={
    spec:document.getElementById('frase-spec').value,
    sub2:document.getElementById('frase-sub2').value||null,
    name:document.getElementById('frase-name').value,
    tags:[],
    text:document.getElementById('frase-text').value
  };
  const{error}=id
    ?await supabaseClient.from('frases').update(payload).eq('id',id)
    :await supabaseClient.from('frases').insert(payload);
  if(error){alert('‚ùå '+error.message);return;}
  closeModal('frases');
  loadData('frases');
}

async function saveChecklist(e){
  e.preventDefault();
  const id=document.getElementById('checklist-id').value;
  let sections;
  try{sections=JSON.parse(document.getElementById('checklist-sections').value);}
  catch(e){alert('‚ùå JSON inv√°lido nas se√ß√µes');return;}
  const payload={
    spec:document.getElementById('checklist-spec').value,
    sub2:document.getElementById('checklist-sub2').value||null,
    name:document.getElementById('checklist-name').value,
    tags:[],
    sections_json:sections
  };
  const{error}=id
    ?await supabaseClient.from('checklists').update(payload).eq('id',id)
    :await supabaseClient.from('checklists').insert(payload);
  if(error){alert('‚ùå '+error.message);return;}
  closeModal('checklists');
  loadData('checklists');
}

async function editItem(tab,id){
  openModal(tab,id);
}

async function deleteItem(tab,id){
  if(!confirm('üóëÔ∏è Deletar este item permanentemente?'))return;
  const{error}=await supabaseClient.from(tab).delete().eq('id',id);
  if(error){alert('‚ùå '+error.message);return;}
  loadData(tab);
}

// Verifica se j√° est√° logado
supabaseClient.auth.getSession().then(({data})=>{
  if(data.session){
    currentUser=data.session.user;
    document.getElementById('login-screen').style.display='none';
    document.getElementById('admin-screen').style.display='block';
    loadData(currentTab);
  }
});
</script>

</body>
</html>
