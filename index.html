<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RadioHub Admin - Firebase</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0b0c10;color:#e2e5f0;min-height:100vh;}

.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;}
.login-box{background:#14161f;border:1px solid #222533;border-radius:12px;padding:2.5rem;width:100%;max-width:420px;}
.login-title{font-size:1.8rem;margin-bottom:0.5rem;color:#fff;}
.login-sub{font-size:0.9rem;color:#8d94b0;margin-bottom:2rem;}

.admin-screen{display:none;padding:2rem;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:2px solid #222533;}
.header-title{font-size:1.8rem;font-weight:700;color:#fff;}
.btn-logout{background:#e05c5c;color:#fff;padding:0.6rem 1.2rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;}

.tabs{display:flex;gap:0.5rem;margin-bottom:2rem;border-bottom:1px solid #222533;}
.tab{padding:0.75rem 1.5rem;background:none;border:none;color:#8d94b0;font-size:0.9rem;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;font-weight:600;}
.tab.active{color:#4f8ef7;border-bottom-color:#4f8ef7;}
.tab:hover{color:#c0c5d8;}

.content{background:#14161f;border:1px solid #222533;border-radius:12px;padding:2rem;}
.btn-new{background:#3fc983;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;margin-bottom:1.5rem;}
.btn-new:hover{background:#32a56b;}

.item-list{display:flex;flex-direction:column;gap:0.75rem;}
.item{background:#1a1d28;border:1px solid #2d3044;border-radius:8px;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
.item-info h3{font-size:1rem;color:#fff;margin-bottom:0.25rem;}
.item-info p{font-size:0.85rem;color:#8d94b0;}
.item-actions{display:flex;gap:0.5rem;}
.btn-sm{padding:0.4rem 0.8rem;font-size:0.8rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;}
.btn-edit{background:#f0944d;color:#fff;}
.btn-delete{background:#e05c5c;color:#fff;}

.form-group{margin-bottom:1.2rem;}
.form-label{display:block;font-size:0.85rem;color:#c0c5d8;margin-bottom:0.5rem;font-weight:600;}
.form-input,select,textarea{width:100%;background:#1a1d28;border:1px solid #2d3044;border-radius:8px;padding:0.7rem 1rem;color:#fff;font-size:0.95rem;}
.form-input:focus,select:focus,textarea:focus{outline:none;border-color:#4f8ef7;}
textarea{min-height:200px;font-family:monospace;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:1000;padding:2rem;}
.modal.show{display:flex;}
.modal-content{background:#14161f;border:1px solid #222533;border-radius:12px;padding:2rem;max-width:1200px;width:100%;max-height:90vh;overflow-y:auto;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
.modal-title{font-size:1.4rem;color:#fff;}
.btn-close{background:none;border:none;color:#8d94b0;font-size:1.5rem;cursor:pointer;}

.toolbar{background:#1a1d28;border:1px solid #2d3044;border-bottom:none;border-radius:8px 8px 0 0;padding:0.8rem;display:flex;gap:0.4rem;flex-wrap:wrap;align-items:center;}
.toolbar button{background:#2d3044;border:1px solid #3d4354;border-radius:6px;padding:0.5rem 0.8rem;color:#e2e5f0;font-size:0.85rem;cursor:pointer;font-weight:600;min-width:36px;}
.toolbar button:hover{background:#3d4354;border-color:#4f8ef7;}
.toolbar .sep{width:1px;height:25px;background:#3d4354;margin:0 0.2rem;}
.toolbar input[type="color"]{width:45px;height:34px;border:1px solid #3d4354;border-radius:6px;cursor:pointer;padding:2px;background:#2d3044;}
.toolbar select{padding:0.5rem 0.7rem;font-size:0.85rem;font-weight:600;background:#2d3044;border:1px solid #3d4354;color:#e2e5f0;}
.editor{min-height:400px;max-height:600px;overflow-y:auto;padding:2rem;border:1px solid #2d3044;border-radius:0 0 8px 8px;background:#1a1d28;font-size:15px;line-height:1.7;color:#e2e5f0;outline:none;}
.editor:focus{border-color:#4f8ef7;}
.editor[contenteditable]:empty:before{content:'Cole do Notion ou comece a digitar...';color:#6b7388;font-style:italic;}
.editor h1{font-size:2em;margin:0.67em 0;color:#fff;}
.editor h2{font-size:1.5em;margin:0.75em 0;color:#fff;}
.editor h3{font-size:1.17em;margin:0.83em 0;color:#fff;}
.editor table{border-collapse:collapse;width:100%;margin:1.5em 0;}
.editor table td,.editor table th{border:1px solid #3d4354;padding:10px;}
.editor table th{background-color:#2d3044;}
.editor img{max-width:100%;border-radius:8px;margin:1em 0;}

.btn-primary{background:#4f8ef7;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.95rem;width:100%;}
.btn-primary:hover{background:#3d7ce3;}
.btn-secondary{background:#2d3044;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:0.95rem;}
.btn-secondary:hover{background:#3d4354;}

.empty{text-align:center;padding:3rem;color:#6b7388;}
.toast{display:none;position:fixed;bottom:2rem;right:2rem;background:#3fc983;color:#fff;padding:1rem 1.5rem;border-radius:8px;font-weight:600;z-index:9999;}
.toast.show{display:block;}
.toast.error{background:#e05c5c;}
input[type="file"]{display:none;}

.loading{text-align:center;padding:2rem;color:#8d94b0;}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <h1 class="login-title">üî• RadioHub Admin <span style="font-size:0.7rem;color:#6b7388;font-weight:400;">v6.0 COMPLETO</span></h1>
    <p class="login-sub">Entre com suas credenciais</p>
    <form onsubmit="login(event)">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="email" required>
      </div>
      <div class="form-group">
        <label class="form-label">Senha</label>
        <input type="password" class="form-input" id="password" required>
      </div>
      <button type="submit" class="btn-primary">Entrar</button>
    </form>
  </div>
</div>

<div class="admin-screen" id="admin-screen">
  <div class="header">
    <h1 class="header-title">üî• RadioHub Admin <span style="font-size:0.6rem;color:#6b7388;font-weight:400;margin-left:0.5rem;">v6.0 COMPLETO!</span></h1>
    <button class="btn-logout" onclick="logout()">Sair</button>
  </div>

  <div class="tabs">
    <button class="tab" onclick="switchTab('templates')">Templates</button>
    <button class="tab" onclick="switchTab('frases')">Frases</button>
    <button class="tab" onclick="switchTab('checklists')">Checklists</button>
    <button class="tab active" onclick="switchTab('resumos')">üìù Resumos (Editor)</button>
  </div>

  <div class="content" id="content">
    <div class="loading">‚è≥ Carregando...</div>
  </div>
</div>

<!-- MODAL RESUMO -->
<div class="modal" id="modal-resumo">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-resumo-title">Novo Resumo</h2>
      <button class="btn-close" onclick="closeModal()">√ó</button>
    </div>
    <form onsubmit="saveResumo(event)">
      <input type="hidden" id="resumo-id">
      
      <div class="form-group">
        <label class="form-label">üìå T√≠tulo *</label>
        <input type="text" class="form-input" id="resumo-titulo" required>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">üè• Especialidade *</label>
          <select id="resumo-spec" required>
            <option value="">Selecione...</option>
            <option value="neuro">Neurorradiologia</option>
            <option value="musculo">Musculoesquel√©tico</option>
            <option value="torax">T√≥rax</option>
            <option value="cardio">Card√≠aca</option>
            <option value="abdominal">Abdominal</option>
            <option value="gi">Gastrointestinal</option>
            <option value="gu">Geniturin√°rio</option>
            <option value="vascular">Vascular</option>
            <option value="mama">Mama</option>
            <option value="pediatria">Pediatria</option>
            <option value="interv">Intervencionista</option>
            <option value="emergencia">Emerg√™ncia</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags (separadas por v√≠rgula)</label>
          <input type="text" class="form-input" id="resumo-tags" placeholder="Ex: RM, Contraste, Les√µes">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">üìÑ Conte√∫do (Cole do Notion) *</label>
        
        <div class="toolbar">
          <button type="button" onclick="execCmd('bold')"><strong>B</strong></button>
          <button type="button" onclick="execCmd('italic')"><em>I</em></button>
          <button type="button" onclick="execCmd('underline')"><u>U</u></button>
          
          <div class="sep"></div>
          
          <select onchange="mudaTamanho(this.value)">
            <option value="">Tamanho</option>
            <option value="1">Pequeno</option>
            <option value="3">Normal</option>
            <option value="5">Grande</option>
            <option value="7">Enorme</option>
          </select>
          
          <div class="sep"></div>
          
          <button type="button" onclick="execCmd('formatBlock','<h1>')">H1</button>
          <button type="button" onclick="execCmd('formatBlock','<h2>')">H2</button>
          <button type="button" onclick="execCmd('formatBlock','<h3>')">H3</button>
          <button type="button" onclick="execCmd('formatBlock','<p>')">P</button>
          
          <div class="sep"></div>
          
          <label style="cursor:pointer;display:flex;align-items:center;background:#2d3044;border:1px solid #3d4354;border-radius:6px;padding:0.5rem 0.8rem;color:#e2e5f0;font-weight:600;">
            üé®
            <input type="color" id="textColor" onchange="mudaCorTexto(this.value)">
          </label>
          
          <label style="cursor:pointer;display:flex;align-items:center;background:#2d3044;border:1px solid #3d4354;border-radius:6px;padding:0.5rem 0.8rem;color:#e2e5f0;font-weight:600;">
            üñçÔ∏è
            <input type="color" id="bgColor" onchange="mudaCorFundo(this.value)">
          </label>
          
          <div class="sep"></div>
          
          <button type="button" onclick="execCmd('insertUnorderedList')">‚Ä¢ Lista</button>
          <button type="button" onclick="execCmd('insertOrderedList')">1. Lista</button>
          
          <div class="sep"></div>
          
          <button type="button" onclick="insertLink()">üîó</button>
          <button type="button" onclick="document.getElementById('imageInput').click()">üñºÔ∏è</button>
          <button type="button" onclick="insertTable()">üìä</button>
          <button type="button" onclick="insertLine()">‚ûñ</button>
          
          <div class="sep"></div>
          
          <button type="button" onclick="execCmd('undo')">‚Ü∂</button>
          <button type="button" onclick="execCmd('redo')">‚Ü∑</button>
          
          <div class="sep"></div>
          
          <button type="button" onclick="execCmd('removeFormat')">‚úï</button>
        </div>
        
        <div class="editor" id="editor" contenteditable="true"></div>
        <input type="file" id="imageInput" accept="image/*" onchange="insertImage(this)">
      </div>
      
      <div style="display:flex;gap:1rem;margin-top:1.5rem;">
        <button type="submit" class="btn-primary">üíæ Salvar Resumo</button>
        <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDPfsLU4-T9MTD8u2_6njXbzcXycGdRRyU",
  authDomain: "radiohub-5335d.firebaseapp.com",
  projectId: "radiohub-5335d",
  storageBucket: "radiohub-5335d.firebasestorage.app",
  messagingSenderId: "838191270589",
  appId: "1:838191270589:web:7ca04a776d9ea1a85305d4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// GLOBALS
window.db = db;
window.auth = auth;
window.collection = collection;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.updateDoc = updateDoc;
window.deleteDoc = deleteDoc;
window.doc = doc;
window.orderBy = orderBy;
window.query = query;
window.signInWithEmailAndPassword = signInWithEmailAndPassword;
window.signOut = signOut;
window.onAuthStateChanged = onAuthStateChanged;

// CHECK AUTH
onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('admin-screen').style.display = 'block';
    switchTab('resumos');
  } else {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('admin-screen').style.display = 'none';
  }
});
</script>

<script>
let currentTab = 'resumos';
const editor = () => document.getElementById('editor');

// LOGIN
window.login = async function(e) {
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  
  try {
    await window.signInWithEmailAndPassword(window.auth, email, password);
    // Auth state change will handle UI update
  } catch (error) {
    console.error('Login error:', error);
    alert('Erro no login: ' + error.message);
  }
}

// LOGOUT
window.logout = async function() {
  try {
    await window.signOut(window.auth);
  } catch (error) {
    console.error('Logout error:', error);
  }
}

// TABS
window.switchTab = function(tab) {
  currentTab = tab;
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t => t.classList.remove('active'));
  if (event && event.target) {
    event.target.classList.add('active');
  } else {
    // Auto-select resumos tab on load
    tabs.forEach(t => {
      if (t.textContent.includes('Resumos')) t.classList.add('active');
    });
  }
  loadContent();
}

async function loadContent() {
  if (currentTab === 'resumos') loadResumos();
  else if (currentTab === 'templates') loadTemplates();
  else if (currentTab === 'frases') loadFrases();
  else if (currentTab === 'checklists') loadChecklists();
  else document.getElementById('content').innerHTML = '<div class="empty">Selecione uma aba</div>';
}

// TEMPLATES
async function loadTemplates() {
  try {
    const q = window.query(window.collection(window.db, 'templates'), window.orderBy('createdAt', 'desc'));
    const snapshot = await window.getDocs(q);
    
    let html = '<button class="btn-new" onclick="openModalTemplate()">+ Novo Template</button>';
    
    if (snapshot.empty) {
      html += '<div class="empty">Nenhum template criado ainda</div>';
    } else {
      html += '<div class="item-list">';
      snapshot.forEach(doc => {
        const t = doc.data();
        html += `
          <div class="item">
            <div class="item-info">
              <h3>${t.nome || 'Sem nome'}</h3>
              <p>${t.especialidade || 'Sem especialidade'} ‚Ä¢ ${t.texto?.length || 0} caracteres</p>
            </div>
            <div class="item-actions">
              <button class="btn-sm btn-edit" onclick='editTemplate("${doc.id}")'>Editar</button>
              <button class="btn-sm btn-delete" onclick='deleteTemplate("${doc.id}")'>Excluir</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    document.getElementById('content').innerHTML = html;
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao carregar templates: ' + error.message, true);
  }
}

window.openModalTemplate = function(docId = null) {
  const modal = `
    <div class="modal show" id="modal-temp">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">${docId ? 'Editar' : 'Novo'} Template</h2>
          <button class="btn-close" onclick="document.getElementById('modal-temp').remove()">√ó</button>
        </div>
        <form onsubmit="saveTemplate(event, '${docId || ''}')">
          <div class="form-group">
            <label class="form-label">üìå Nome *</label>
            <input type="text" class="form-input" id="temp-nome" required>
          </div>
          <div class="form-group">
            <label class="form-label">üè• Especialidade</label>
            <select id="temp-spec">
              <option value="">Selecione...</option>
              <option value="neuro">Neurorradiologia</option>
              <option value="musculo">Musculoesquel√©tico</option>
              <option value="torax">T√≥rax</option>
              <option value="cardio">Card√≠aca</option>
              <option value="abdominal">Abdominal</option>
              <option value="gi">Gastrointestinal</option>
              <option value="gu">Geniturin√°rio</option>
              <option value="vascular">Vascular</option>
              <option value="mama">Mama</option>
              <option value="pediatria">Pediatria</option>
              <option value="interv">Intervencionista</option>
              <option value="emergencia">Emerg√™ncia</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">üìÑ Texto do Template *</label>
            <textarea id="temp-texto" required></textarea>
          </div>
          <div style="display:flex;gap:1rem;margin-top:1.5rem;">
            <button type="submit" class="btn-primary">üíæ Salvar</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('modal-temp').remove()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modal);
  
  if (docId) {
    window.getDocs(window.collection(window.db, 'templates')).then(snapshot => {
      snapshot.forEach(d => {
        if (d.id === docId) {
          const data = d.data();
          document.getElementById('temp-nome').value = data.nome || '';
          document.getElementById('temp-spec').value = data.especialidade || '';
          document.getElementById('temp-texto').value = data.texto || '';
        }
      });
    });
  }
}

window.editTemplate = function(id) {
  openModalTemplate(id);
}

window.saveTemplate = async function(e, id) {
  e.preventDefault();
  
  const dados = {
    nome: document.getElementById('temp-nome').value.trim(),
    especialidade: document.getElementById('temp-spec').value,
    texto: document.getElementById('temp-texto').value.trim(),
    createdAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await window.updateDoc(window.doc(window.db, 'templates', id), dados);
    } else {
      await window.addDoc(window.collection(window.db, 'templates'), dados);
    }
    
    showToast('‚úì Template salvo!');
    document.getElementById('modal-temp').remove();
    loadTemplates();
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao salvar: ' + error.message, true);
  }
}

window.deleteTemplate = async function(id) {
  if (!confirm('Excluir template?')) return;
  try {
    await window.deleteDoc(window.doc(window.db, 'templates', id));
    showToast('‚úì Deletado!');
    loadTemplates();
  } catch (error) {
    showToast('Erro: ' + error.message, true);
  }
}

// FRASES
async function loadFrases() {
  try {
    const q = window.query(window.collection(window.db, 'frases'), window.orderBy('createdAt', 'desc'));
    const snapshot = await window.getDocs(q);
    
    let html = '<button class="btn-new" onclick="openModalFrase()">+ Nova Frase</button>';
    
    if (snapshot.empty) {
      html += '<div class="empty">Nenhuma frase criada ainda</div>';
    } else {
      html += '<div class="item-list">';
      snapshot.forEach(doc => {
        const f = doc.data();
        html += `
          <div class="item">
            <div class="item-info">
              <h3>${f.categoria || 'Sem categoria'}</h3>
              <p>${f.texto?.substring(0, 100) || 'Sem texto'}...</p>
            </div>
            <div class="item-actions">
              <button class="btn-sm btn-edit" onclick='editFrase("${doc.id}")'>Editar</button>
              <button class="btn-sm btn-delete" onclick='deleteFrase("${doc.id}")'>Excluir</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    document.getElementById('content').innerHTML = html;
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao carregar frases: ' + error.message, true);
  }
}

window.openModalFrase = function(docId = null) {
  const modal = `
    <div class="modal show" id="modal-frase">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">${docId ? 'Editar' : 'Nova'} Frase</h2>
          <button class="btn-close" onclick="document.getElementById('modal-frase').remove()">√ó</button>
        </div>
        <form onsubmit="saveFrase(event, '${docId || ''}')">
          <div class="form-group">
            <label class="form-label">üìÅ Categoria *</label>
            <input type="text" class="form-input" id="frase-cat" required placeholder="Ex: Achados Normais, Limita√ß√µes...">
          </div>
          <div class="form-group">
            <label class="form-label">üí¨ Texto da Frase *</label>
            <textarea id="frase-texto" required></textarea>
          </div>
          <div style="display:flex;gap:1rem;margin-top:1.5rem;">
            <button type="submit" class="btn-primary">üíæ Salvar</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('modal-frase').remove()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modal);
  
  if (docId) {
    window.getDocs(window.collection(window.db, 'frases')).then(snapshot => {
      snapshot.forEach(d => {
        if (d.id === docId) {
          const data = d.data();
          document.getElementById('frase-cat').value = data.categoria || '';
          document.getElementById('frase-texto').value = data.texto || '';
        }
      });
    });
  }
}

window.editFrase = function(id) {
  openModalFrase(id);
}

window.saveFrase = async function(e, id) {
  e.preventDefault();
  
  const dados = {
    categoria: document.getElementById('frase-cat').value.trim(),
    texto: document.getElementById('frase-texto').value.trim(),
    createdAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await window.updateDoc(window.doc(window.db, 'frases', id), dados);
    } else {
      await window.addDoc(window.collection(window.db, 'frases'), dados);
    }
    
    showToast('‚úì Frase salva!');
    document.getElementById('modal-frase').remove();
    loadFrases();
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao salvar: ' + error.message, true);
  }
}

window.deleteFrase = async function(id) {
  if (!confirm('Excluir frase?')) return;
  try {
    await window.deleteDoc(window.doc(window.db, 'frases', id));
    showToast('‚úì Deletado!');
    loadFrases();
  } catch (error) {
    showToast('Erro: ' + error.message, true);
  }
}

// CHECKLISTS
async function loadChecklists() {
  try {
    const q = window.query(window.collection(window.db, 'checklists'), window.orderBy('createdAt', 'desc'));
    const snapshot = await window.getDocs(q);
    
    let html = '<button class="btn-new" onclick="openModalChecklist()">+ Novo Checklist</button>';
    
    if (snapshot.empty) {
      html += '<div class="empty">Nenhum checklist criado ainda</div>';
    } else {
      html += '<div class="item-list">';
      snapshot.forEach(doc => {
        const c = doc.data();
        html += `
          <div class="item">
            <div class="item-info">
              <h3>${c.nome || 'Sem nome'}</h3>
              <p>${c.exame || 'Sem exame'} ‚Ä¢ ${c.itens?.length || 0} itens</p>
            </div>
            <div class="item-actions">
              <button class="btn-sm btn-edit" onclick='editChecklist("${doc.id}")'>Editar</button>
              <button class="btn-sm btn-delete" onclick='deleteChecklist("${doc.id}")'>Excluir</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    document.getElementById('content').innerHTML = html;
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao carregar checklists: ' + error.message, true);
  }
}

window.openModalChecklist = function(docId = null) {
  const modal = `
    <div class="modal show" id="modal-check">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">${docId ? 'Editar' : 'Novo'} Checklist</h2>
          <button class="btn-close" onclick="document.getElementById('modal-check').remove()">√ó</button>
        </div>
        <form onsubmit="saveChecklist(event, '${docId || ''}')">
          <div class="form-group">
            <label class="form-label">üìå Nome *</label>
            <input type="text" class="form-input" id="check-nome" required placeholder="Ex: Checklist RM Abdome">
          </div>
          <div class="form-group">
            <label class="form-label">üî¨ Tipo de Exame *</label>
            <input type="text" class="form-input" id="check-exame" required placeholder="Ex: RM, TC, RX...">
          </div>
          <div class="form-group">
            <label class="form-label">‚úÖ Itens (um por linha) *</label>
            <textarea id="check-itens" required placeholder="Protocolo adequado&#10;Qualidade t√©cnica&#10;Artefatos..."></textarea>
          </div>
          <div style="display:flex;gap:1rem;margin-top:1.5rem;">
            <button type="submit" class="btn-primary">üíæ Salvar</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('modal-check').remove()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modal);
  
  if (docId) {
    window.getDocs(window.collection(window.db, 'checklists')).then(snapshot => {
      snapshot.forEach(d => {
        if (d.id === docId) {
          const data = d.data();
          document.getElementById('check-nome').value = data.nome || '';
          document.getElementById('check-exame').value = data.exame || '';
          document.getElementById('check-itens').value = (data.itens || []).join('\n');
        }
      });
    });
  }
}

window.editChecklist = function(id) {
  openModalChecklist(id);
}

window.saveChecklist = async function(e, id) {
  e.preventDefault();
  
  const itensText = document.getElementById('check-itens').value.trim();
  const itens = itensText.split('\n').map(i => i.trim()).filter(i => i.length > 0);
  
  const dados = {
    nome: document.getElementById('check-nome').value.trim(),
    exame: document.getElementById('check-exame').value.trim(),
    itens: itens,
    createdAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await window.updateDoc(window.doc(window.db, 'checklists', id), dados);
    } else {
      await window.addDoc(window.collection(window.db, 'checklists'), dados);
    }
    
    showToast('‚úì Checklist salvo!');
    document.getElementById('modal-check').remove();
    loadChecklists();
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao salvar: ' + error.message, true);
  }
}

window.deleteChecklist = async function(id) {
  if (!confirm('Excluir checklist?')) return;
  try {
    await window.deleteDoc(window.doc(window.db, 'checklists', id));
    showToast('‚úì Deletado!');
    loadChecklists();
  } catch (error) {
    showToast('Erro: ' + error.message, true);
  }
}

// RESUMOS
async function loadResumos() {
  try {
    const q = window.query(window.collection(window.db, 'resumos'), window.orderBy('createdAt', 'desc'));
    const snapshot = await window.getDocs(q);
    
    let html = '<button class="btn-new" onclick="openModal()">+ Novo Resumo com Editor</button>';
    
    if (snapshot.empty) {
      html += '<div class="empty">Nenhum resumo criado ainda</div>';
    } else {
      html += '<div class="item-list">';
      snapshot.forEach(doc => {
        const r = doc.data();
        html += `
          <div class="item">
            <div class="item-info">
              <h3>${r.titulo || 'Sem t√≠tulo'}</h3>
              <p>${r.spec || 'Sem especialidade'} ‚Ä¢ ${r.palavras || 0} palavras</p>
            </div>
            <div class="item-actions">
              <button class="btn-sm btn-edit" onclick='editResumo("${doc.id}")'>Editar</button>
              <button class="btn-sm btn-delete" onclick='deleteResumo("${doc.id}")'>Excluir</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    document.getElementById('content').innerHTML = html;
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao carregar resumos: ' + error.message, true);
  }
}

window.openModal = function(docId = null) {
  if (docId) {
    // EDIT
    window.getDocs(window.collection(window.db, 'resumos')).then(snapshot => {
      snapshot.forEach(d => {
        if (d.id === docId) {
          const data = d.data();
          document.getElementById('modal-resumo-title').textContent = 'Editar Resumo';
          document.getElementById('resumo-id').value = d.id;
          document.getElementById('resumo-titulo').value = data.titulo || '';
          document.getElementById('resumo-spec').value = data.spec || '';
          document.getElementById('resumo-tags').value = (data.tags || []).join(', ');
          editor().innerHTML = data.body || '';
        }
      });
    });
  } else {
    // NEW
    document.getElementById('modal-resumo-title').textContent = 'Novo Resumo';
    document.getElementById('resumo-id').value = '';
    document.getElementById('resumo-titulo').value = '';
    document.getElementById('resumo-spec').value = '';
    document.getElementById('resumo-tags').value = '';
    editor().innerHTML = '';
  }
  document.getElementById('modal-resumo').classList.add('show');
}

window.editResumo = function(id) {
  openModal(id);
}

window.saveResumo = async function(e) {
  e.preventDefault();
  
  const id = document.getElementById('resumo-id').value;
  const titulo = document.getElementById('resumo-titulo').value.trim();
  const spec = document.getElementById('resumo-spec').value;
  const tagsStr = document.getElementById('resumo-tags').value;
  const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];
  const body = editor().innerHTML;
  const texto = editor().innerText.trim();
  const palavras = texto.split(/\s+/).filter(w => w.length > 0).length;
  
  const dados = {
    titulo: titulo,
    spec: spec,
    tags: tags,
    body: body,
    texto: texto,
    palavras: palavras,
    createdAt: new Date().toISOString()
  };
  
  try {
    if (id) {
      await window.updateDoc(window.doc(window.db, 'resumos', id), dados);
    } else {
      await window.addDoc(window.collection(window.db, 'resumos'), dados);
    }
    
    showToast('‚úì Salvo com sucesso!');
    closeModal();
    loadResumos();
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao salvar: ' + error.message, true);
  }
}

window.deleteResumo = async function(id) {
  if (!confirm('Excluir resumo?')) return;
  
  try {
    await window.deleteDoc(window.doc(window.db, 'resumos', id));
    showToast('‚úì Deletado!');
    loadResumos();
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao deletar: ' + error.message, true);
  }
}

window.closeModal = function() {
  document.getElementById('modal-resumo').classList.remove('show');
}

function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// EDITOR
function execCmd(cmd, value = null) {
  document.execCommand(cmd, false, value);
  editor().focus();
}

function mudaTamanho(size) {
  if (size) execCmd('fontSize', size);
}

function mudaCorTexto(cor) {
  execCmd('foreColor', cor);
}

function mudaCorFundo(cor) {
  execCmd('backColor', cor);
}

function insertLink() {
  const url = prompt('Cole a URL:');
  if (url) execCmd('createLink', url);
}

function insertImage(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    execCmd('insertImage', e.target.result);
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function insertTable() {
  const rows = prompt('Linhas:', '3');
  const cols = prompt('Colunas:', '3');
  if (!rows || !cols) return;
  
  let html = '<table style="border-collapse:collapse;width:100%;margin:1.5rem 0;border:1px solid #3d4354;">';
  for (let i = 0; i < rows; i++) {
    html += '<tr>';
    for (let j = 0; j < cols; j++) {
      const style = 'padding:10px;border:1px solid #3d4354;';
      html += i === 0 ? `<th style="${style}background:#2d3044;">T√≠tulo</th>` : `<td style="${style}">C√©lula</td>`;
    }
    html += '</tr>';
  }
  html += '</table><p><br></p>';
  execCmd('insertHTML', html);
}

function insertLine() {
  execCmd('insertHTML', '<hr style="border:none;border-top:2px solid #3d4354;margin:2rem 0;"><p><br></p>');
}

window.execCmd = execCmd;
window.mudaTamanho = mudaTamanho;
window.mudaCorTexto = mudaCorTexto;
window.mudaCorFundo = mudaCorFundo;
window.insertLink = insertLink;
window.insertImage = insertImage;
window.insertTable = insertTable;
window.insertLine = insertLine;

// Atalhos
editor().addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); execCmd('bold'); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'i') { e.preventDefault(); execCmd('italic'); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'u') { e.preventDefault(); execCmd('underline'); }
});
</script>

</body>
</html>
